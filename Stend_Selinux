create virtual mashine Centos7 in Vagrant & SElinux
------------------------------------------------------------------------
# -*- mode: ruby -*-
# vim: set ft=ruby :


MACHINES = {
  :selinux => {
        :box_name => "centos/7",
        :box_version => "2004.01",
        #:provision => "test.sh",       
  },
}


Vagrant.configure("2") do |config|


  MACHINES.each do |boxname, boxconfig|


      config.vm.define boxname do |box|


        box.vm.box = boxconfig[:box_name]
        box.vm.box_version = boxconfig[:box_version]


        box.vm.host_name = "selinux"
        box.vm.network "forwarded_port", guest: 4881, host: 4881


        box.vm.provider :virtualbox do |vb|
              vb.customize ["modifyvm", :id, "--memory", "1024"]
              needsController = false
        end


        box.vm.provision "shell", inline: <<-SHELL
          #install epel-release
          yum install -y epel-release
          #install nginx
          yum install -y nginx
          #change nginx port
          sed -ie 's/:80/:4881/g' /etc/nginx/nginx.conf
          sed -i 's/listen       80;/listen       4881;/' /etc/nginx/nginx.conf
          #disable SELinux
          #setenforce 0
          #start nginx
          systemctl start nginx
          systemctl status nginx
          #check nginx port
          ss -tlpn | grep 4881
        SHELL
    end
  end
end


***************************************************Vagrant UP****************************************
localadm@DEB:~/otus$ vagrant up
Bringing machine 'selinux' up with 'virtualbox' provider...
==> selinux: Importing base box 'centos/7'...
==> selinux: Matching MAC address for NAT networking...
==> selinux: Checking if box 'centos/7' version '2004.01' is up to date...
==> selinux: Setting the name of the VM: otus_selinux_1688418943670_67917
==> selinux: Clearing any previously set network interfaces...
==> selinux: Preparing network interfaces based on configuration...
    selinux: Adapter 1: nat
==> selinux: Forwarding ports...
    selinux: 4881 (guest) => 4881 (host) (adapter 1)
    selinux: 22 (guest) => 2222 (host) (adapter 1)
==> selinux: Running 'pre-boot' VM customizations...
==> selinux: Booting VM...
==> selinux: Waiting for machine to boot. This may take a few minutes...
    selinux: SSH address: 127.0.0.1:2222
    selinux: SSH username: vagrant
    selinux: SSH auth method: private key
    selinux: 
    selinux: Vagrant insecure key detected. Vagrant will automatically replace
    selinux: this with a newly generated keypair for better security.
    selinux: 
    selinux: Inserting generated public key within guest...
    selinux: Removing insecure key from the guest if it's present...
    selinux: Key inserted! Disconnecting and reconnecting using new SSH key...
==> selinux: Machine booted and ready!
==> selinux: Checking for guest additions in VM...
    selinux: No guest additions were detected on the base box for this VM! Guest
    selinux: additions are required for forwarded ports, shared folders, host only
    selinux: networking, and more. If SSH fails on this machine, please install
    selinux: the guest additions and repackage the box to continue.
    selinux: 
    selinux: This is not an error message; everything may continue to work properly,
    selinux: in which case you may ignore this message.
==> selinux: Setting hostname...
==> selinux: Rsyncing folder: /home/localadm/otus/ => /vagrant
==> selinux: Running provisioner: shell...
    selinux: Running: inline script
    selinux: Loaded plugins: fastestmirror
    selinux: Determining fastest mirrors
    selinux:  * base: ftp.jaist.ac.jp
    selinux:  * extras: ftp.jaist.ac.jp
    selinux:  * updates: ftp.jaist.ac.jp
    selinux: Resolving Dependencies
    selinux: --> Running transaction check
    selinux: ---> Package epel-release.noarch 0:7-11 will be installed
    selinux: --> Finished Dependency Resolution
    selinux: 
    selinux: Dependencies Resolved
    selinux: 
    selinux: ================================================================================
    selinux:  Package                Arch             Version         Repository        Size
    selinux: ================================================================================
    selinux: Installing:
    selinux:  epel-release           noarch           7-11            extras            15 k
    selinux: 
    selinux: Transaction Summary
    selinux: ================================================================================
    selinux: Install  1 Package
    selinux: 
    selinux: Total download size: 15 k
    selinux: Installed size: 24 k
    selinux: Downloading packages:
    selinux: Public key for epel-release-7-11.noarch.rpm is not installed
    selinux: warning: /var/cache/yum/x86_64/7/extras/packages/epel-release-7-11.noarch.rpm: Header V3 RSA/SHA256 Signature, key ID f4a80eb5: NOKEY
    selinux: Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    selinux: Importing GPG key 0xF4A80EB5:
    selinux:  Userid     : "CentOS-7 Key (CentOS 7 Official Signing Key) <security@centos.org>"
    selinux:  Fingerprint: 6341 ab27 53d7 8a78 a7c2 7bb1 24c6 a8a7 f4a8 0eb5
    selinux:  Package    : centos-release-7-8.2003.0.el7.centos.x86_64 (@anaconda)
    selinux:  From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    selinux: Running transaction check
    selinux: Running transaction test
    selinux: Transaction test succeeded
    selinux: Running transaction
    selinux:   Installing : epel-release-7-11.noarch                                     1/1
    selinux:   Verifying  : epel-release-7-11.noarch                                     1/1
    selinux: 
    selinux: Installed:
    selinux:   epel-release.noarch 0:7-11
    selinux: 
    selinux: Complete!
    selinux: Loaded plugins: fastestmirror
    selinux: Loading mirror speeds from cached hostfile
    selinux:  * base: ftp.jaist.ac.jp
    selinux:  * epel: mirror-icn.yuki.net.uk
    selinux:  * extras: ftp.jaist.ac.jp
    selinux:  * updates: ftp.jaist.ac.jp
    selinux: Resolving Dependencies
    selinux: --> Running transaction check
    selinux: ---> Package nginx.x86_64 1:1.20.1-10.el7 will be installed
    selinux: --> Processing Dependency: nginx-filesystem = 1:1.20.1-10.el7 for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: libcrypto.so.1.1(OPENSSL_1_1_0)(64bit) for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: libssl.so.1.1(OPENSSL_1_1_0)(64bit) for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: libssl.so.1.1(OPENSSL_1_1_1)(64bit) for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: nginx-filesystem for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: redhat-indexhtml for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: system-logos for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: libcrypto.so.1.1()(64bit) for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: libprofiler.so.0()(64bit) for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Processing Dependency: libssl.so.1.1()(64bit) for package: 1:nginx-1.20.1-10.el7.x86_64
    selinux: --> Running transaction check
    selinux: ---> Package centos-indexhtml.noarch 0:7-9.el7.centos will be installed
    selinux: ---> Package centos-logos.noarch 0:70.0.6-3.el7.centos will be installed
    selinux: ---> Package gperftools-libs.x86_64 0:2.6.1-1.el7 will be installed
    selinux: ---> Package nginx-filesystem.noarch 1:1.20.1-10.el7 will be installed
    selinux: ---> Package openssl11-libs.x86_64 1:1.1.1k-5.el7 will be installed
    selinux: --> Finished Dependency Resolution
    selinux: 
    selinux: Dependencies Resolved
    selinux: 
    selinux: ================================================================================
    selinux:  Package                Arch         Version                   Repository  Size
    selinux: ================================================================================
    selinux: Installing:
    selinux:  nginx                  x86_64       1:1.20.1-10.el7           epel       588 k
    selinux: Installing for dependencies:
    selinux:  centos-indexhtml       noarch       7-9.el7.centos            base        92 k
    selinux:  centos-logos           noarch       70.0.6-3.el7.centos       base        21 M
    selinux:  gperftools-libs        x86_64       2.6.1-1.el7               base       272 k
    selinux:  nginx-filesystem       noarch       1:1.20.1-10.el7           epel        24 k
    selinux:  openssl11-libs         x86_64       1:1.1.1k-5.el7            epel       1.5 M
    selinux: 
    selinux: Transaction Summary
    selinux: ================================================================================
    selinux: Install  1 Package (+5 Dependent packages)
    selinux: 
    selinux: Total download size: 24 M
    selinux: Installed size: 28 M
    selinux: Downloading packages:
    selinux: Public key for nginx-filesystem-1.20.1-10.el7.noarch.rpm is not installed
    selinux: warning: /var/cache/yum/x86_64/7/epel/packages/nginx-filesystem-1.20.1-10.el7.noarch.rpm: Header V4 RSA/SHA256 Signature, key ID 352c64e5: NOKEY
    selinux: --------------------------------------------------------------------------------
    selinux: Total                                              569 kB/s |  24 MB  00:42
    selinux: Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
    selinux: Importing GPG key 0x352C64E5:
    selinux:  Userid     : "Fedora EPEL (7) <epel@fedoraproject.org>"
    selinux:  Fingerprint: 91e9 7d7c 4a5e 96f1 7f3e 888f 6a2f aea2 352c 64e5
    selinux:  Package    : epel-release-7-11.noarch (@extras)
    selinux:  From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
    selinux: Running transaction check
    selinux: Running transaction test
    selinux: Transaction test succeeded
    selinux: Running transaction
    selinux:   Installing : centos-logos-70.0.6-3.el7.centos.noarch                      1/6
    selinux:   Installing : 1:openssl11-libs-1.1.1k-5.el7.x86_64                         2/6
    selinux:   Installing : centos-indexhtml-7-9.el7.centos.noarch                       3/6
    selinux:   Installing : gperftools-libs-2.6.1-1.el7.x86_64                           4/6
    selinux:   Installing : 1:nginx-filesystem-1.20.1-10.el7.noarch                      5/6
    selinux:   Installing : 1:nginx-1.20.1-10.el7.x86_64                                 6/6
    selinux:   Verifying  : 1:nginx-filesystem-1.20.1-10.el7.noarch                      1/6
    selinux:   Verifying  : gperftools-libs-2.6.1-1.el7.x86_64                           2/6
    selinux:   Verifying  : 1:nginx-1.20.1-10.el7.x86_64                                 3/6
    selinux:   Verifying  : centos-indexhtml-7-9.el7.centos.noarch                       4/6
    selinux:   Verifying  : 1:openssl11-libs-1.1.1k-5.el7.x86_64                         5/6
    selinux:   Verifying  : centos-logos-70.0.6-3.el7.centos.noarch                      6/6
    selinux: 
    selinux: Installed:
    selinux:   nginx.x86_64 1:1.20.1-10.el7
    selinux: 
    selinux: Dependency Installed:
    selinux:   centos-indexhtml.noarch 0:7-9.el7.centos
    selinux:   centos-logos.noarch 0:70.0.6-3.el7.centos
    selinux:   gperftools-libs.x86_64 0:2.6.1-1.el7
    selinux:   nginx-filesystem.noarch 1:1.20.1-10.el7
    selinux:   openssl11-libs.x86_64 1:1.1.1k-5.el7
    selinux: 
    selinux: Complete!
    selinux: Job for nginx.service failed because the control process exited with error code. See "systemctl status nginx.service" and "journalctl -xe" for details.
    selinux: ● nginx.service - The nginx HTTP and reverse proxy server
    selinux:    Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
    selinux:    Active: failed (Result: exit-code) since Mon 2023-07-03 21:18:37 UTC; 8ms ago
    selinux:   Process: 2889 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=1/FAILURE)
    selinux:   Process: 2888 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)
    selinux: 
    selinux: Jul 03 21:18:37 selinux systemd[1]: Starting The nginx HTTP and reverse proxy server...
    selinux: Jul 03 21:18:37 selinux nginx[2889]: nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
    selinux: Jul 03 21:18:37 selinux nginx[2889]: nginx: [emerg] bind() to 0.0.0.0:4881 failed (13: Permission denied)
    selinux: Jul 03 21:18:37 selinux nginx[2889]: nginx: configuration file /etc/nginx/nginx.conf test failed
    selinux: Jul 03 21:18:37 selinux systemd[1]: nginx.service: control process exited, code=exited status=1
    selinux: Jul 03 21:18:37 selinux systemd[1]: Failed to start The nginx HTTP and reverse proxy server.
    selinux: Jul 03 21:18:37 selinux systemd[1]: Unit nginx.service entered failed state.
    selinux: Jul 03 21:18:37 selinux systemd[1]: nginx.service failed.
**************************************************************************************
vagrant@selinux ~]$ sudo su                                                # raise privilege untill root
*******************************************Status firewall inactive*********************
[root@selinux vagrant]# systemctl status firewalld                         # Check status firewall 
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)
***************************************************nginx conf ok*************************
nginx -t                                                                    # Enter comand and check config nginx 
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
***************************************************getenforce ***************************
[root@selinux vagrant]#  getenforce                                          # Getenforce reports whether SELinux is enforcing
Enforcing
                                                       
                                                                  
