 - name: install 
   hosts: vm
   become: true
   tasks:
    - name: install update and program
      apt:
        update_cache: yes
        name: 
        - traceroute
        - iptables
        - iptables-persistent
        - conntrack
        - tcpdump
        - knockd
        - curl
        state: latest
         
    - name: enable forwarding  
      sysctl:
        name: net.ipv4.conf.all.forwarding
        value: '1'
        state: present  
    
    - name: setup block inetRouter
      block:
        - name: setup template iptabels inetRouter 
          template:
            src: Rout/inetRouter.j2
            dest: /etc/network/interfaces
            owner: root
            group: root
            mode: 0644

        - name: enable knockd
          lineinfile:
            path: /etc/default/knockd
            regexp: 'START_KNOCKD'
            line: 'START_KNOCKD=1'

        - name: enable int knockd
          lineinfile:
            path: /etc/default/knockd
            regexp: '#KNOCKD_OPTS'
            line: 'KNOCKD_OPTS="-i eth1"'

        - name: configured knockd
          template:
            src: Knockd/knockd_conf.j2
            dest: /etc/knockd.conf
            owner: root
            group: root
            mode: 0755
        
        - name: temlate knock service(default service not work)
          template:
            src: Knockd/knockd_service.j2
            dest: /lib/systemd/system/knockd.service
            owner: root
            group: root
            mode: 0755
        
        - name: service knocked
          service:
            name: knockd
            state: started
            enabled: yes
     

        - name: start enable 
          service:
            name: knockd
            enabled: true

        - name: iptables rules
          template:
            src: Iptables/inet_rout.j2
            dest: /etc/iptables/rules.v4
            owner: root
            group: root
            mode: 0755

        - name: create dir 
          file:
            path: /root/.ssh
            state: directory

        - name: create file authorized
          file:
            path: /root/.ssh/authorized_keys
            state: touch
            owner: root
            group: root
            mode: '775'

      when: (ansible_hostname == "inetRouter")
      become: true
      become_user: root

    - name: install to centRouter
      block:
        - name: setup route on CentRouter
          template:
            src: Rout/centRouter.j2
            dest: /etc/network/interfaces
            owner: root
            group: root
            mode: 0644

        - name: create dir 
          file:
            path:  /root/.ssh
            state: directory

        - name: Generate an ssh-keygen
          become: yes
          openssh_keypair:
            path: /root/.ssh/id_rsa
            owner: root
            group: root

        - name: Copy id_rsa to main vm
          fetch:
            src: /root/.ssh/id_rsa.pub
            dest: "{{ inventory_hostname }}_id_rsa.pub"
            flat: yes 
    
        - name: Copy to InetRouter
          copy:
            src: "{{ inventory_hostname }}_id_rsa.pub"
            dest: /root/.ssh/authorized_keys
            mode: '0600'
          delegate_to: inetRouter

        - name: script knock
          template:
            src: Knockd/script.sh 
            dest: /root/
            owner: root
            group: root
            mode: 0777

      when: (ansible_hostname == "centRouter")
      become: true
      become_user: root

    - name: preference inetRouter2
      block:
        - name: setup route on inetRouter2
          template:
            src: Rout/inetRouter2.j2
            dest: /etc/network/interfaces
            owner: root
            group: root
            mode: 0644
    
        - name: iptables rules
          template: 
            src: Iptables/inet2_rout.j2
            dest: /etc/iptables/rules.v4
            owner: root
            group: root
            mode: 0755

        - name: setup route on inetServer
          template:
            src: Rout/inetServer.j2
            dest: /etc/network/interfaces
            owner: root
            group: root
            mode: 0644
     
        - name: install nginx
          apt:
            name: nginx
            state: latest

        - name: edit nginx listen port
          template:
            src: Temp_nginx/nginx.j2
            dest: /etc/nginx/sites-enabled/default 
       
        - name: service nginx
          service:
            name: nginx
            state: restarted

      when: (ansible_hostname == "inetServer")
      become: true
      become_user: root


    - name: reboot all hosts 
      block:
        - shell: systemctl reboot
          async: 300
          poll: 0
          ignore_errors: true


    - name: wait for system hosts
      wait_for_connection:
        delay: 60
        timeout: 300 

