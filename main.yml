---
   
  - name: Net
    hosts: "intRout"
    become: true
    tasks:
      - name: install iptables & add rules nat
        yum:
          name:
            - iptables
            - iptables-services
            - traceroute 
      - name: create template Nat
        template:
          src: iptables
          dest: /etc/sysconfig/iptables
          owner: root
          group: root
          mode: "600"
      - name: start service iptables
        service:
          name: iptables
          state: started
          enabled: true
      
  - name: enable fowarding for all routers
    hosts: "all_router"
    become: true
    tasks:      
      - name: enable forwarding  
        sysctl:
          name: net.ipv4.conf.all.forwarding
          value: '1'
          state: present  
  
  - name: all hosts
    hosts: all
    become: true
    tasks:
      - name: install traceroute
        apt:
          update_cache: yes
          name: traceroute
          state: latest
        when: ( ansible_os_family == "Debian") or 
              (ansible_os_family == "Ubuntu")
      
      - name: install traceroute for Centos
        yum: 
          update_cache: true    
          name: traceroute
          state: latest
        when: ( ansible_os_family == "RedHat") 

      - name: disable default route
        lineinfile: 
          path: /etc/sysconfig/network-scripts/ifcfg-eth0  
          line: DEFROUTE=NO
        when: (ansible_hostname == "centRout") or 
              (ansible_hostname == "dirSer")
      
      - name: add default gatw centRout
        lineinfile:
          path: /etc/sysconfig/network-scripts/ifcfg-eth1
          line: GATEWAY=192.168.255.1
        when: (ansible_hostname == "centRout")
          
      - name: add default gateway for dirSer
        lineinfile:
          path: /etc/sysconfig/network-scripts/ifcfg-eth1
          line: GATEWAY=192.168.0.1 
        when: (ansible_hostname == "dirSer")

      - name: add file from interface dirSer and intRout
        file:
          path: /etc/sysconfig/network-scripts/route-eth1
          owner: root
          group: root
          mode: '0644'
          state: touch
        when: (ansible_hostname == "intRout") or 
              (ansible_hostname == "dirSer")
 

      - name: add static rout intRout
        blockinfile:
          path: /etc/sysconfig/network-scripts/route-eth1
          block: |
            192.168.0.0/22 via 192.168.255.2
            192.168.2.0/24 via 192.168.255.2
            192.168.3.0/24 via 192.168.255.2
            192.168.255.10/30 via 192.168.255.2
            192.168.255.6/30 via 192.168.255.2  
        when: (ansible_hostname == "intRout")

      - name: add folder rout 
        file:
          path: /etc/sysconfig/network-scripts/route-eth3
          owner: root
          group: root
          mode: '0644'
          state: touch
        when: (ansible_hostname == "centRout")

      - name: add file dirSer and intRout
        file:
          path: /etc/sysconfig/network-scripts/route-eth5
          owner: root
          group: root
          mode: '0644'
          state: touch
        when: (ansible_hostname == "centRout")

      - name: add static rout dirSer
        lineinfile:
          path: /etc/sysconfig/network-scripts/route-eth3
          line: " 192.168.2.0/24 via 192.168.255.10"
        when: (ansible_hostname == "centRout")
          
      - name: add static rout dirSer
        lineinfile:
          path: /etc/sysconfig/network-scripts/route-eth5
          line: " 192.168.3.0/24 via 192.168.255.6"
        when: (ansible_hostname == "centRout")

      - name: setup route on off1Ser
        template:
          src: off1Ser.j2 
          dest: /etc/netplan/50-vagrant.yaml
          owner: root
          group: root
          mode: 0644
        when: (ansible_hostname == "off1Ser")

      - name: setup route on off2Ser
        template:
          src: off2Ser.j2
          dest: /etc/network/interfaces
          owner: root
          group: root
          mode: 0644
        when: (ansible_hostname == "off2Ser")
      
      - name: setup route on off1Rout
        template:
          src: off1Rout.j2 
          dest: /etc/netplan/50-vagrant.yaml
          owner: root
          group: root
          mode: 0644
        when: (ansible_hostname == "off1Rout")

      - name: setup route on off2Rout
        template:
          src: off2Rout.j2
          dest: /etc/network/interfaces
          owner: root
          group: root
          mode: 0644
        when: (ansible_hostname == "off2Rout")

      - name: reboot all hosts 
        block:
        - shell: systemctl reboot
          async: 200
          poll: 0
          ignore_errors: true

      - name: wait for system hosts
        wait_for_connection:
          delay: 60
          timeout: 200
...
