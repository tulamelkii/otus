---
 - name: PXE
   hosts: pxeserver
   become: true
   vars_files:
     - vars.yml
   tasks:

     - name: change repo 
       lineinfile:
         path: "{{ item }}"
         regexp: 'mirrorlist'
         line: '#mirrorlist'
       loop:
       - /etc/yum.repos.d/CentOS-Linux-AppStream.repo
       - /etc/yum.repos.d/CentOS-Linux-BaseOS.repo
     - name: change repo
       lineinfile:
         path: /etc/yum.repos.d/CentOS-Linux-AppStream.repo
         regexp: '#baseurl'
         line: 'baseurl=http://archive.kernel.org/centos-vault/8.4.2105/AppStream/x86_64/os/'
     - name: change repo
       lineinfile:
         path: /etc/yum.repos.d/CentOS-Linux-BaseOS.repo
         regexp: '#baseurl'
         line:  'baseurl=http://archive.kernel.org/centos-vault/8.4.2105/BaseOS/x86_64/os/'
    
     - name: install programs
       yum:
         name:
           - vim
           - wget
           - epel-release
           - httpd
           - tftp-server
           - dhcp-server
         state: present
         update_cache: true
     - name: Download iso Centos
       get_url:
         url: https://archive.kernel.org/centos-vault/8.4.2105/isos/x86_64/CentOS-8.4.2105-x86_64-dvd1.iso
         dest: '/root/CentOS-8.4.2105-x86_64-dvd1.iso'
         mode: 0755

     - name: mount iso centos8
       mount: 
         path: /mnt
         src: '/root/CentOS-8.4.2105-x86_64-dvd1.iso'
         fstype: iso9660
         opts: ro,loop
         state: mounted
       
     - name: create directory for iso 
       file:
         path: /iso
         state: directory
         mode: 0755
           
     - name: coppy iso with directory
       copy:
         src: "{{ item }}" 
         dest: /iso
         remote_src: yes    
       with_items:
         - "/mnt/"
     
     - name: create folder for  pxe.boot
       file:
         path: /etc/httpd/conf.d/pxeboot.conf
         state: touch
         mode: 0755
     
     - name: config pxe.boot
       blockinfile:
         path: /etc/httpd/conf.d/pxeboot.conf
         block: |
           Alias /centos8 /iso
           <Directory /iso>
           Options Indexes FollowSymLinks
           Require all granted
           </Directory>
    
     - name: restart httpd
       service:
         name: httpd
         state: restarted
         enabled: yes

     - name: start tftp service
       service:
         name: tftp
         state: started
         enabled: yes

     - name: crate dir menu save boot
       file:
         path: /var/lib/tftpboot/
         state: directory
         mode: 0755

     - name: crate dir pxelinux
       file:
         path: /var/lib/tftpboot/pxelinux.cfg
         state: directory
         mode: 0755

     - name: create file default
       file:
         path: /var/lib/tftpboot/pxelinux.cfg/default
         state: touch
         mode: 0755

     - name: add conf pxe
       template:
         src: pxelinux.cfg
         dest: /var/lib/tftpboot/pxelinux.cfg/default
         mode: 0755
     
     - name: extract packages syslinux
       shell: rpm2cpio /iso/BaseOS/Packages/syslinux-tftpboot-6.04-5.el8.noarch.rpm | cpio -dimv
     
     - name: copy file tftpboot
       copy:
         src: /home/vagrant/tftpboot/{{ item }}
         dest: /var/lib/tftpboot/{{ item }}
         remote_src: yes 
       with_items:
         - pxelinux.0
         - ldlinux.c32
         - libmenu.c32
         - libutil.c32
         - menu.c32
         - vesamenu.c32

     - name: copy initrd and vmlinuz
       copy:
         src:  /iso/images/pxeboot/{{ item }}
         dest: /var/lib/tftpboot/{{ item }}
         remote_src: yes
       with_items:
         - initrd.img
         - vmlinuz

     - name: create file config kikstarter
       file:
         path: /iso/ks.cfg
         state: touch
         mode: 0755

     - name: configured ks.cfg
       template:
         src: ks.cfg
         dest: /iso/ks.cfg
         mode: 0755
    
     - name: restart tftp-server
       service:
         name: tftp.service
         state: started
         enabled: true
      
     - name: set up dhcp-server
       template:
         src: dhcpd.conf
         dest: /etc/dhcp/dhcpd.conf
         mode: '0644'
     - name: start dhcp-server
       service:
         name: dhcpd
         state: started
         enabled: true





  


